name: ðŸ›’ Scrape ALDI Products
on:
  schedule:
    - cron: "0 1 * * 0"
  workflow_dispatch:
permissions:
  contents: write
jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      - name: ðŸ“ Ensure directories
        run: mkdir -p data logs
      - name: ðŸ“¥ Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: ðŸ” Check GitHub API rate limit
        run: |
          RATE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/rate_limit | jq '.rate.remaining')
          echo "ðŸ“Š Remaining API calls: $RATE"
          if [ "$RATE" -lt 100 ]; then
            echo "âš ï¸ Rate limit trop bas, workflow annulÃ©"
            exit 1
          fi
      - name: ðŸ”‘ Verify ALGOLIA_API_KEY secret
        run: |
          if [ -z "${{ secrets.ALGOLIA_API_KEY }}" ]; then
            echo "âŒ Secret ALGOLIA_API_KEY manquant. Ajoutez-le dans Settings â†’ Secrets â†’ Actions."
            exit 1
          fi
      - name: ðŸ¤– Run ALDI scraper
        run: python -m scripts.scraper
        env:
          PYTHONUNBUFFERED: 1
          ALGOLIA_API_KEY: ${{ secrets.ALGOLIA_API_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
      - name: ðŸ” Check for changes
        id: check_changes
        run: |
          if git diff --quiet data/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      - name: ðŸ“¤ Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ¤– Mise Ã  jour ALDI - ${{ github.run_id }}"
          commit_user_name: "aldi-scraper-bot"
          commit_user_email: "bot@github-actions"
          file_pattern: "data/*.json"
      - name: âœ… Success info
        if: success()
        run: |
          echo "âœ… Scraping terminÃ©!"
          echo "ðŸ“Š Produits: $(jq '.meta.total_products' data/products.json)"
          echo "ðŸ“… MAJ: $(jq -r '.meta.last_updated' data/products.json)"
          echo "ðŸ’¾ Taille JSON: $(du -h data/products.json | cut -f1)"
          echo "ðŸ’¾ Taille minimale: $(du -h data/products-min.json | cut -f1)"
